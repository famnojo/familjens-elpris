<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elpriser SE3</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 2em;
      margin: 20px 0;
    }
    h2 {
      font-size: 1.5em;
      margin-top: 30px;
    }
    .best-time {
      font-size: 1.3em;
      font-weight: bold;
      margin: 10px 0;
      color: #0f0;
    }
    .chart-container {
      width: 95%;
      max-width: 600px;
      margin: auto;
    }
    .mean-text {
      margin: 5px 0 20px 0;
      color: yellow;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h1>Elpriser SE3</h1>

  <div id="today-section">
    <h2>Idag</h2>
    <div id="best-time-today" class="best-time"></div>
    <div class="chart-container"><canvas id="todayChart"></canvas></div>
    <div id="mean-today" class="mean-text"></div>
  </div>

  <div id="tomorrow-section">
    <h2>Imorgon</h2>
    <div id="best-time-tomorrow" class="best-time"></div>
    <div class="chart-container"><canvas id="tomorrowChart"></canvas></div>
    <div id="mean-tomorrow" class="mean-text"></div>
  </div>

  <script>
    async function loadData() {
      try {
        const response = await fetch("data.json");
        const data = await response.json();

        // Hämta svensk tid
        const now = new Date();
        const todayStr = now.toLocaleDateString("sv-SE");
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        const tomorrowStr = tomorrow.toLocaleDateString("sv-SE");

        // Bygg upp data per dag
        function getDayData(dateStr) {
          let labels = [];
          let values = [];
          for (let i = 0; i < data.hours.length; i++) {
            const d = new Date(data.hours[i]);
            const dStr = d.toLocaleDateString("sv-SE");
            if (dStr === dateStr) {
              labels.push(d.getHours() + ":00");
              values.push(data.prices_ore_per_kwh[i]);
            }
          }
          return { labels, values };
        }

        const todayData = getDayData(todayStr);
        const tomorrowData = getDayData(tomorrowStr);

        function getBestWindow(labels, values, hoursNeeded) {
          if (labels.length < hoursNeeded) return null;
          let bestAvg = Infinity;
          let bestIndex = 0;
          for (let i = 0; i <= values.length - hoursNeeded; i++) {
            const avg = values.slice(i, i + hoursNeeded).reduce((a, b) => a + b, 0) / hoursNeeded;
            if (avg < bestAvg) {
              bestAvg = avg;
              bestIndex = i;
            }
          }
          return `${labels[bestIndex]} - ${labels[bestIndex + hoursNeeded - 1]}`;
        }

        function renderChart(ctx, labels, values, mean, bestElem, meanElem) {
          if (!labels.length) {
            bestElem.textContent = "Ingen data tillgänglig.";
            return;
          }

          const bestWindow = getBestWindow(labels, values, 5);
          bestElem.textContent = bestWindow ? `Bästa tiden att ladda bilen: ${bestWindow}` : "";

          const colors = values.map(v => v < mean ? "green" : "red");

          new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "öre/kWh",
                  data: values,
                  backgroundColor: colors
                },
                {
                  label: "Snitt",
                  data: Array(labels.length).fill(mean),
                  type: "line",
                  borderColor: "yellow",
                  borderWidth: 2,
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  suggestedMax: Math.max(...values) + 5,
                  title: { display: true, text: "öre/kWh", color: "#fff" },
                  ticks: { color: "#fff" }
                },
                x: {
                  ticks: { color: "#fff" }
                }
              },
              plugins: {
                legend: { labels: { color: "#fff" } }
              }
            }
          });

          meanElem.textContent = `Dagens snitt: ${mean.toFixed(2)} öre/kWh`;
        }

        const ctxToday = document.getElementById("todayChart").getContext("2d");
        renderChart(
          ctxToday,
          todayData.labels,
          todayData.values,
          data.mean_ore_per_kwh,
          document.getElementById("best-time-today"),
          document.getElementById("mean-today")
        );

        const ctxTomorrow = document.getElementById("tomorrowChart").getContext("2d");
        renderChart(
          ctxTomorrow,
          tomorrowData.labels,
          tomorrowData.values,
          data.mean_ore_per_kwh,
          document.getElementById("best-time-tomorrow"),
          document.getElementById("mean-tomorrow")
        );

      } catch (e) {
        document.body.innerHTML = "<p>Kunde inte läsa data.json.</p>";
      }
    }

    loadData();
  </script>
</body>
</html>
