<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(async function(){
  const tz='Europe/Stockholm';
  const fmtTime = d => d.toLocaleString('sv-SE',{timeZone:tz,hour:'2-digit',minute:'2-digit'});
  const fmtOre = v => `${Math.round(v)} öre`;

  async function loadJSON(url){
    try{
      const r = await fetch(url+'?ts='+Date.now(),{cache:'no-store'});
      if(!r.ok) return null;
      return await r.json();
    }catch{return null}
  }

  function norm(json){
    if(!json) return null;
    if(Array.isArray(json)){
      const hours=json.map(x=>x.time_start);
      const prices=json.map(x=>Number(x.SEK_per_kWh)*100);
      const mean=prices.length?prices.reduce((a,b)=>a+b,0)/prices.length:0;
      const generated_at=json[0]?.time_start||null;
      return {hours,prices,mean,generated_at};
    }
    if(json.hours && json.prices_ore_per_kwh){
      return {
        hours: json.hours,
        prices: json.prices_ore_per_kwh.map(Number),
        mean: Number(json.mean_ore_per_kwh||0),
        generated_at: json.generated_at||null
      };
    }
    return null;
  }

  function findBest5(hoursISO, prices){
    if(!hoursISO || prices.length<5) return null;
    let bestStart=0, bestAvg=Infinity;
    for(let i=0;i<=prices.length-5;i++){
      const avg=(prices[i]+prices[i+1]+prices[i+2]+prices[i+3]+prices[i+4])/5;
      if(avg<bestAvg){bestAvg=avg;bestStart=i;}
    }
    const start=new Date(hoursISO[bestStart]);
    const endStart=new Date(hoursISO[bestStart+4]);
    const end=new Date(endStart.getTime()+60*60*1000);
    return {start,end,avg:bestAvg};
  }

  function renderChart(canvasId,hoursISO,prices,mean){
    const labels=hoursISO.map(h=>{
      const d=new Date(h);
      return d.toLocaleString('sv-SE',{timeZone:tz,weekday:'short',hour:'2-digit'}).replace(':00','');
    });
    const colors=prices.map(p=>p<mean?'rgba(34,197,94,0.85)':'rgba(239,68,68,0.85)');
    const maxVal=prices.length?Math.max(...prices):0;
    const suggestedMax=Math.round(Math.max(maxVal,mean)*1.1);

    new Chart(document.getElementById(canvasId),{
      type:'bar',
      data:{labels,datasets:[
        {label:'öre/kWh',data:prices,backgroundColor:colors},
        {label:'Snitt',type:'line',data:new Array(prices.length).fill(mean),
         borderColor:'rgba(250,204,21,1)',borderWidth:2,pointRadius:0}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{y:{beginAtZero:true,suggestedMax,
          title:{display:true,text:'öre/kWh',color:'#e5e7eb'},ticks:{color:'#e5e7eb',precision:0}},
               x:{ticks:{color:'#e5e7eb'}}},
        plugins:{legend:{labels:{color:'#e5e7eb'}}}
      }
    });
  }

  // Försök IDAG: data/today.json -> data.json
  const todayRaw = await loadJSON('./data/today.json') || await loadJSON('./data.json');
  const today = norm(todayRaw);

  // Försök IMORGON: data/tomorrow.json -> kolla om morgondag finns i data.json-format (today/tomorrow-lista stöds också)
  let tomorrow = norm(await loadJSON('./data/tomorrow.json'));
  if(!tomorrow){
    const root = await loadJSON('./data.json');
    if(root?.tomorrow_hours && root?.tomorrow_prices){
      tomorrow = {hours:root.tomorrow_hours,prices:root.tomorrow_prices.map(Number),
                  mean:Number(root.tomorrow_mean||0),generated_at:root.generated_at||null};
    } else if (Array.isArray(root?.tomorrow)) {
      tomorrow = norm(root.tomorrow); // if someone stored raw list under "tomorrow"
    }
  }

  // Senast uppdaterad
  const updated = today?.generated_at || tomorrow?.generated_at || null;
  if(updated) document.getElementById('updated')?.textContent =
      'Senast uppdaterad: '+new Date(updated).toLocaleString('sv-SE',{timeZone:tz});

  // Render Idag
  if(today?.hours?.length && today?.prices?.length){
    document.getElementById('todayMean').textContent = fmtOre(today.mean);
    const best = findBest5(today.hours,today.prices);
    document.getElementById('todayBest').textContent = best ?
      `${fmtTime(best.start)} – ${fmtTime(best.end)}  ·  snitt ${fmtOre(best.avg)}` : '–';
    renderChart('todayChart',today.hours,today.prices,today.mean);
  } else {
    document.getElementById('todayCard').querySelector('.chartwrap').innerHTML =
      '<div class="legend">Hittade ingen data för idag. Kontrollera att <code>data/today.json</code> eller <code>data.json</code> finns.</div>';
  }

  // Render Imorgon (om finns)
  if(tomorrow?.hours?.length && tomorrow?.prices?.length){
    document.getElementById('tomorrowCard').style.display='block';
    document.getElementById('tomorrowMean').textContent = fmtOre(tomorrow.mean);
    const bestT = findBest5(tomorrow.hours,tomorrow.prices);
    document.getElementById('tomorrowBest').textContent = bestT ?
      `${fmtTime(bestT.start)} – ${fmtTime(bestT.end)}  ·  snitt ${fmtOre(bestT.avg)}` : '–';
    renderChart('tomorrowChart',tomorrow.hours,tomorrow.prices,tomorrow.mean);
  }
})();
</script>
