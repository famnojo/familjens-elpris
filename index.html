<body class="bg-black text-white">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Elpriser SE3</h1>

    <div id="today-section">
      <h2 class="text-xl font-semibold mb-2">Dagens priser</h2>
      <canvas id="todayChart"></canvas>
      <div id="todayWindow" class="text-lg mt-2"></div>
    </div>

    <div id="tomorrow-section" style="display:none; margin-top:2rem;">
      <h2 class="text-xl font-semibold mb-2">Morgondagens priser</h2>
      <canvas id="tomorrowChart"></canvas>
      <div id="tomorrowWindow" class="text-lg mt-2"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function loadData(file) {
      try {
        const response = await fetch(file);
        if (!response.ok) return null;
        return await response.json();
      } catch (e) {
        return null;
      }
    }

    function renderChart(data, chartId, windowId) {
      if (!data) return;
      const ctx = document.getElementById(chartId).getContext("2d");
      const prices = data.prices_ore_per_kwh;
      const labels = data.hours.map(h => new Date(h).getHours() + ":00");
      const mean = data.mean_ore_per_kwh;

      const colors = prices.map(p => (p <= mean ? "green" : "red"));

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "öre/kWh",
            data: prices,
            backgroundColor: colors
          },
          {
            label: "Dagens snitt",
            data: Array(prices.length).fill(mean),
            type: "line",
            borderColor: "yellow",
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: Math.ceil(Math.max(...prices) / 10) * 10
            }
          }
        }
      });

      // Bästa laddfönster (5 timmar)
      const window5 = data.windows["5"] ? data.windows["5"][0] : null;
      if (window5) {
        document.getElementById(windowId).innerText =
          `Bästa tiden att ladda bilen: ${new Date(window5.start).getHours()}:00 – ${new Date(window5.end).getHours()}:00`;
      }
    }

    (async () => {
      const today = await loadData("data/today.json");
      if (today) renderChart(today, "todayChart", "todayWindow");

      const tomorrow = await loadData("data/tomorrow.json");
      if (tomorrow) {
        document.getElementById("tomorrow-section").style.display = "block";
        renderChart(tomorrow, "tomorrowChart", "tomorrowWindow");
      }
    })();
  </script>
</body>
