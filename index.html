<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elpriser SE3 – Topp 5 & under medel</title>
  <style>
    :root{ --bg:#0b132b; --fg:#e5e7eb; --card:#111827; --muted:#94a3b8; --accent:#22c55e; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--fg); }
    header{ padding:16px 20px; border-bottom:1px solid #1f2937; }
    h1{ margin:0; font-size:20px; }
    .sub{ color:var(--muted); margin-top:4px; font-size:14px; }
    main{ max-width:820px; margin:0 auto; padding:16px; display:grid; gap:16px; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:16px; }
    h2{ margin:0 0 10px; font-size:18px; }
    .grid{ display:flex; flex-direction:column; gap:8px; }
    .row{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid #1f2937; border-radius:10px; }
    .row .time{ font-variant-numeric: tabular-nums; }
    .row .price{ color:var(--accent); font-weight:600; font-variant-numeric: tabular-nums; }
    .muted{ color:var(--muted); }
    .bold{ font-weight:700; }
    footer{ text-align:center; color:var(--muted); padding:10px 16px; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>Elpriser SE3</h1>
    <div class="sub">Senast uppdaterad: <span id="updated">…</span></div>
  </header>

  <main>
    <section class="card">
      <h2>Topp 5 billigaste timmarna</h2>
      <div id="top5" class="grid"></div>
      <div id="top5empty" class="muted" style="display:none">Inga data just nu.</div>
    </section>

    <section class="card">
      <h2>Alla timmar under medel (billigast → dyrast)</h2>
      <div id="underMean" class="grid"></div>
      <div id="underEmpty" class="muted" style="display:none">Inga timmar under medel hittades.</div>
    </section>
  </main>

  <footer>
    Data från <code>data.json</code> • Priser i öre/kWh
  </footer>

<script>
(async function(){
  try{
    const res = await fetch('./data.json?ts='+Date.now());
    const data = await res.json();

    const fmtUpdated = (iso) =>
      new Date(iso).toLocaleString('sv-SE', { timeZone: 'Europe/Stockholm' });

    // Visa "senast uppdaterad"
    if (data.generated_at) {
      document.getElementById('updated').textContent = fmtUpdated(data.generated_at);
    }

    // Bygg {time, price} från data.json
    const items = (data.hours || []).map((h, i) => ({
      timeISO: h,
      price: (data.prices_ore_per_kwh || [])[i]
    })).filter(x => typeof x.price === 'number' && !Number.isNaN(x.price));

    // Medelpris (om inte finns i JSON, räkna)
    const mean = typeof data.mean_ore_per_kwh === 'number'
      ? data.mean_ore_per_kwh
      : (items.length ? items.reduce((a,b)=>a+b.price,0)/items.length : 0);

    // Under medel
    const under = items.filter(x => x.price < mean);

    // Topp 5 (bland under medel), sorterat billigast→dyrast
    const top5 = under.slice().sort((a,b)=>a.price - b.price).slice(0,5);

    // Hjälpare: format
    const fmtTime = (iso) => {
      const d = new Date(iso);
      // t.ex. "fre 15/08 14:00"
      return d.toLocaleString('sv-SE', {
        timeZone: 'Europe/Stockholm',
        weekday: 'short', day: '2-digit', month: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    };
    const fmtOre = (v) => `${Math.round(v)} öre`;

    // Render-funktion
    const renderRows = (arr, elId, emptyId, topSet = null) => {
      const el = document.getElementById(elId);
      if (!arr.length){ document.getElementById(emptyId).style.display='block'; return; }
      arr.forEach(x=>{
        const row = document.createElement('div');
        row.className = 'row';
        const isTop = topSet && topSet.has(x.timeISO);
        row.innerHTML = `
          <div class="time ${isTop ? 'bold' : ''}">${fmtTime(x.timeISO)}</div>
          <div class="price">${fmtOre(x.price)}</div>
        `;
        el.appendChild(row);
      });
    };

    // Render Topp 5
    renderRows(top5, 'top5', 'top5empty');

    // Alla under medel, sorterade billigast→dyrast
    const underSorted = under.slice().sort((a,b)=>a.price - b.price);
    const topSet = new Set(top5.map(x=>x.timeISO));
    renderRows(underSorted, 'underMean', 'underEmpty', topSet);

  }catch(e){
    document.querySelector('main').innerHTML =
      '<div class="card"><p class="muted">Kunde inte läsa data.json. Ladda upp den igen.</p></div>';
    console.error(e);
  }
})();
</script>
</body>
</html>
