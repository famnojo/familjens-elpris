<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadData() {
  try {
    const response = await fetch("data.json");
    const data = await response.json();

    renderDay(
      "todayChart",
      "Dagens priser",
      data.today_hours,
      data.today_prices,
      data.today_mean
    );

    if (data.tomorrow_hours) {
      renderDay(
        "tomorrowChart",
        "Morgondagens priser",
        data.tomorrow_hours,
        data.tomorrow_prices,
        data.tomorrow_mean
      );
    }
  } catch (e) {
    document.body.innerHTML += "<p>Kunde inte läsa data.json</p>";
  }
}

function renderDay(canvasId, title, hours, prices, mean) {
  const ctx = document.getElementById(canvasId).getContext("2d");

  const colors = prices.map(p => (p < mean ? "green" : "red"));

  const chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: hours.map(h => h.slice(11,16)), // HH:MM
      datasets: [
        {
          label: "öre/kWh",
          data: prices,
          backgroundColor: colors
        },
        {
          label: "Snittpris",
          type: "line",
          data: Array(prices.length).fill(mean),
          borderColor: "yellow",
          borderWidth: 2,
          pointRadius: 0
        }
      ]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: title,
          color: "white",
          font: { size: 20 }
        }
      },
      scales: {
        x: { ticks: { color: "white" } },
        y: {
          ticks: { color: "white" },
          beginAtZero: true,
          suggestedMax: Math.max(...prices) + 5
        }
      }
    }
  });

  // Bästa 5h fönster
  const best = bestWindow(hours, prices, 5);
  const elem = document.getElementById(canvasId + "-best");
  if (best) {
    elem.textContent =
      "Bästa tiden att ladda bilen: " +
      formatHour(hours[best.start]) + " – " +
      formatHour(new Date(new Date(hours[best.end]).getTime() + 60*60*1000));
  }
}

function bestWindow(hours, prices, windowSize) {
  if (prices.length < windowSize) return null;
  let minAvg = Infinity;
  let bestStart = 0;
  for (let i = 0; i <= prices.length - windowSize; i++) {
    const avg = prices.slice(i, i + windowSize).reduce((a,b)=>a+b,0)/windowSize;
    if (avg < minAvg) {
      minAvg = avg;
      bestStart = i;
    }
  }
  return { start: bestStart, end: bestStart + windowSize - 1 };
}

function formatHour(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
}

loadData();
</script>
