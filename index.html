<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Elpriser SE3</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b132b; --fg:#e5e7eb; --card:#111827; --muted:#9ca3af;
      --ok:#22c55e; --bad:#ef4444; --mean:#facc15;
      --wrapH: 420px; --wrapH-lg: 520px; --maxW: 980px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--fg); }
    header{ padding:16px 20px; border-bottom:1px solid #1f2937; }
    h1{ margin:0; font-size:26px; line-height:1.2; }
    main{ max-width:var(--maxW); margin:0 auto; padding:16px; display:grid; gap:16px; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:16px; }
    .title{ font-size:20px; font-weight:700; margin-bottom:8px; }
    .bestTitle{ font-size: clamp(20px, 7vw, 30px); font-weight:800; margin-bottom:6px; }
    .best{ font-size: clamp(16px, 6vw, 24px); font-weight:700; margin:0 0 12px; color:#22c55e; }
    .chartwrap{ height: var(--wrapH); }
    @media (min-width:900px){ .chartwrap{ height: var(--wrapH-lg); } }
    .legend{ color:var(--muted); font-size:13px; margin-top:8px; }
    .meanLabel{ color:var(--mean); font-size:16px; margin-top:10px; }
    .status{ margin-top:8px; color:var(--muted); font-size:13px; }
    .err{ color:#fecaca; background:#7f1d1d; border:1px solid #b91c1c; padding:10px; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Elpriser SE3</h1>
  </header>

  <main>
    <!-- IDAG -->
    <section class="card">
      <div class="title">Idag</div>
      <div class="bestTitle">Bästa tiden att ladda bilen</div>
      <div id="best-today" class="best">–</div>
      <div class="chartwrap"><canvas id="todayChart"></canvas></div>
      <div class="meanLabel">Dygnssnitt: <span id="mean-today">–</span></div>
      <div id="status-today" class="status"></div>
    </section>

    <!-- IMORGON (visas bara om filen finns) -->
    <section id="tomorrowSection" class="card" style="display:none;">
      <div class="title">Imorgon</div>
      <div class="bestTitle">Bästa tiden att ladda bilen</div>
      <div id="best-tomorrow" class="best">–</div>
      <div class="chartwrap"><canvas id="tomorrowChart"></canvas></div>
      <div class="meanLabel">Dygnssnitt: <span id="mean-tomorrow">–</span></div>
      <div id="status-tomorrow" class="status"></div>
    </section>
  </main>

<script>
const tz = 'Europe/Stockholm';

function localYMD(d=new Date()){
  return new Intl.DateTimeFormat('sv-SE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'})
    .format(d).replaceAll('-', '');
}
function dateISOtoYMD(iso){
  return iso.slice(0,10).replaceAll('-',''); // "2025-08-19" -> "20250819"
}
function sameLocalHour(aISO, bDate){
  const a = new Date(aISO);
  const fmt = (d)=> new Intl.DateTimeFormat('sv-SE',{timeZone:tz,hour:'2-digit'}).format(d);
  return fmt(a) === fmt(bDate);
}

async function readDay(path){
  try{
    const r = await fetch(path + '?t=' + Date.now(), {cache:'no-store'});
    if(!r.ok) return {ok:false, status:r.status};
    const arr = await r.json();
    if(!Array.isArray(arr) || arr.length !== 24) return {ok:false, error:'Fel format (måste vara 24 rader)'};
    const hoursISO = arr.map(x => x.time_start);
    const pricesOre = arr.map(x => Math.round(Number(x.SEK_per_kWh)*10000)/100); // SEK -> öre
    const mean = pricesOre.reduce((a,b)=>a+b,0)/pricesOre.length;
    return {ok:true, hoursISO, pricesOre, mean};
  }catch(e){
    return {ok:false, error:String(e)};
  }
}

function findBest5(hoursISO, prices){
  if(prices.length < 5) return null;
  let bestIdx = 0, bestAvg = Infinity;
  for(let i=0;i<=prices.length-5;i++){
    const avg = (prices[i]+prices[i+1]+prices[i+2]+prices[i+3]+prices[i+4])/5;
    if(avg < bestAvg){ bestAvg = avg; bestIdx = i; }
  }
  const start = new Date(hoursISO[bestIdx]);
  const endStart = new Date(hoursISO[bestIdx+4]);
  const end = new Date(endStart.getTime() + 60*60*1000);
  const fmt = d => d.toLocaleTimeString('sv-SE',{timeZone:tz,hour:'2-digit',minute:'2-digit'});
  return {text: `${fmt(start)} – ${fmt(end)}`, avg: bestAvg};
}

function render(canvasId, hoursISO, prices, mean){
  const now = new Date();
  const labels = hoursISO.map(h => new Date(h).toLocaleTimeString('sv-SE',{timeZone:tz,hour:'2-digit'}));

  // Färglogik:
  // - vit för aktuell timme
  // - grön om p < 0.85*mean
  // - gul om 0.85*mean <= p < mean
  // - röd om p >= mean
  const thr = 0.85*mean;
  const colors = prices.map((p,i)=>{
    if (sameLocalHour(hoursISO[i], now)) return 'rgba(255,255,255,0.95)'; // vit
    if (p < thr) return 'rgba(34,197,94,0.9)';    // grön
    if (p < mean) return 'rgba(250,204,21,0.9)';  // gul
    return 'rgba(239,68,68,0.9)';                 // röd
  });

  const maxVal = Math.max(...prices, mean);
  const suggestedMax = Math.ceil(maxVal * 1.1);

  new Chart(document.getElementById(canvasId), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'öre/kWh', data: prices, backgroundColor: colors },
        { label:'Snitt', type:'line', data: new Array(prices.length).fill(mean),
          borderColor:'rgba(250,204,21,1)', borderWidth:2, pointRadius:0, fill:false }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{
        y:{ beginAtZero:true, suggestedMax,
            title:{display:true,text:'öre/kWh',color:'#e5e7eb'},
            ticks:{ color:'#e5e7eb', precision:0 } },
        x:{ ticks:{ color:'#e5e7eb' } }
      },
      plugins:{ legend:{ labels:{ color:'#e5e7eb' } } }
    }
  });
}

async function init(){
  // Läs in idag + ev. imorgon
  const tRes = await readDay('data/today.json');
  let useToday = tRes.ok ? tRes : null;

  // Midnattsswitch: om today.json inte gäller dagens datum → använd tomorrow.json som “Idag”
  const localTodayYMD = localYMD();
  if (useToday && tRes.hoursISO?.[0] && dateISOtoYMD(tRes.hoursISO[0]) !== localTodayYMD) {
    const tr2 = await readDay('data/tomorrow.json');
    if (tr2.ok && tr2.hoursISO?.[0] && dateISOtoYMD(tr2.hoursISO[0]) === localTodayYMD) {
      useToday = tr2; // visa imorgon-filen som "Idag" efter midnatt
      // Dölj Imorgon-sektionen i så fall — den kommer tillbaka när ny morgondag släpps 14:30
      const sec = document.getElementById('tomorrowSection');
      if (sec) sec.style.display = 'none';
    }
  }

  const st = document.getElementById('status-today');
  if(!useToday){
    st.innerHTML = `<span class="err">Kunde inte läsa data/today.json</span>`;
  }else{
    document.getElementById('mean-today').textContent = `${useToday.mean.toFixed(1)} öre/kWh`;
    const best = findBest5(useToday.hoursISO, useToday.pricesOre);
    document.getElementById('best-today').textContent = best ? `${best.text} · snitt ${best.avg.toFixed(1)} öre` : '–';
    render('todayChart', useToday.hoursISO, useToday.pricesOre, useToday.mean);
    st.textContent = 'Laddade 24 timmar för idag.';
  }

  // Försök rendera Imorgon (om filen finns och inte redan används som “Idag”)
  const tr = await fetch('data/tomorrow.json?t='+Date.now(), {cache:'no-store'});
  if(tr.ok){
    const data = await tr.json();
    if(Array.isArray(data) && data.length === 24){
      const hoursISO = data.map(x=>x.time_start);
      // om vi redan använde tomorrow som “Idag”, hoppa över
      if (useToday && hoursISO[0] && dateISOtoYMD(hoursISO[0]) === dateISOtoYMD(useToday.hoursISO[0])) {
        return;
      }
      const pricesOre = data.map(x=>Math.round(Number(x.SEK_per_kWh)*10000)/100);
      const mean = pricesOre.reduce((a,b)=>a+b,0)/pricesOre.length;

      document.getElementById('tomorrowSection').style.display = 'block';
      document.getElementById('mean-tomorrow').textContent = `${mean.toFixed(1)} öre/kWh`;
      const bestT = findBest5(hoursISO, pricesOre);
      document.getElementById('best-tomorrow').textContent = bestT ? `${bestT.text} · snitt ${bestT.avg.toFixed(1)} öre` : '–';
      render('tomorrowChart', hoursISO, pricesOre, mean);
      document.getElementById('status-tomorrow').textContent = 'Laddade 24 timmar för imorgon.';
    }
  }
}
init();
</script>
</body>
</html>
